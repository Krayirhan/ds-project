import { useEffect, useMemo, useState } from 'react';
import {
  CategoryScale,
  Chart,
  BarController,
  BarElement,
  LinearScale,
  LineController,
  LineElement,
  PointElement,
  Legend,
  Tooltip,
} from 'chart.js';
import { getDbStatus, getOverview, getRuns, login, logout, me } from './api';

Chart.register(
  CategoryScale,
  LinearScale,
  BarController,
  BarElement,
  LineController,
  LineElement,
  PointElement,
  Legend,
  Tooltip,
);

function f(value, digits = 4) {
  if (value === null || value === undefined || Number.isNaN(Number(value))) return '-';
  return Number(value).toFixed(digits);
}

function pct(value, digits = 1) {
  if (value === null || value === undefined || Number.isNaN(Number(value))) return '-';
  return `%${(Number(value) * 100).toFixed(digits)}`;
}

export default function App() {
  const [authenticated, setAuthenticated] = useState(false);
  const [currentUser, setCurrentUser] = useState('');
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [loginError, setLoginError] = useState('');

  const [activePage, setActivePage] = useState('overview');
  const [apiKey, setApiKey] = useState('');
  const [runs, setRuns] = useState([]);
  const [selectedRun, setSelectedRun] = useState('');
  const [data, setData] = useState(null);
  const [dbStatus, setDbStatus] = useState(null);
  const [error, setError] = useState('');

  function authFailed(err) {
    const message = String(err?.message || err || 'Bilinmeyen hata');
    if (message.includes('401')) {
      localStorage.removeItem('dashboard_token');
      setAuthenticated(false);
      setLoginError('Oturum süresi doldu. Lütfen tekrar giriş yapın.');
      return true;
    }
    return false;
  }

  async function refreshRunsAndData() {
    setError('');
    try {
      const runPayload = await getRuns(apiKey);
      const availableRuns = runPayload.runs || [];
      setRuns(availableRuns);

      const runForOverview = selectedRun || availableRuns[0] || '';
      if (runForOverview && runForOverview !== selectedRun) {
        setSelectedRun(runForOverview);
      }

      const overview = await getOverview(runForOverview, apiKey);
      setData(overview);
    } catch (err) {
      if (!authFailed(err)) setError(err.message);
    }
  }

  async function refreshOverviewOnly(runId = selectedRun) {
    setError('');
    try {
      const overview = await getOverview(runId, apiKey);
      setData(overview);
    } catch (err) {
      if (!authFailed(err)) setError(err.message);
    }
  }

  async function refreshDbStatus() {
    setError('');
    try {
      const status = await getDbStatus(apiKey);
      setDbStatus(status);
    } catch (err) {
      if (!authFailed(err)) setError(err.message);
    }
  }

  async function handleLogin(e) {
    e.preventDefault();
    setLoginError('');
    try {
      const payload = await login(username, password);
      localStorage.setItem('dashboard_token', payload.access_token);
      setAuthenticated(true);
      setCurrentUser(payload.username || username);
      setPassword('');
      await refreshRunsAndData();
    } catch (err) {
      setLoginError(err.message || 'Giriş yapılamadı.');
    }
  }

  async function handleLogout() {
    try {
      await logout();
    } catch (_err) {
      // no-op
    }
    localStorage.removeItem('dashboard_token');
    setAuthenticated(false);
    setCurrentUser('');
    setData(null);
    setRuns([]);
    setDbStatus(null);
  }

  useEffect(() => {
    const token = localStorage.getItem('dashboard_token');
    if (!token) {
      setAuthenticated(false);
      return;
    }

    me()
      .then((payload) => {
        setAuthenticated(true);
        setCurrentUser(payload.username || '');
        refreshRunsAndData();
      })
      .catch(() => {
        localStorage.removeItem('dashboard_token');
        setAuthenticated(false);
      });
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  useEffect(() => {
    if (!authenticated) return;
    if (activePage === 'system') {
      refreshDbStatus();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [activePage, authenticated]);

  const modelRows = data?.models || [];
  const champion = data?.champion || {};
  const generatedAt = data?.generated_at
    ? new Date(data.generated_at).toLocaleString('tr-TR')
    : '-';

  const chartDataset = useMemo(() => {
    const labels = modelRows.map((m) => m.model_name || '-');
    return {
      labels,
      trainAuc: modelRows.map((m) => m.train_cv_roc_auc_mean ?? null),
      testAuc: modelRows.map((m) => m.test_roc_auc ?? null),
      testF1: modelRows.map((m) => m.test_f1 ?? null),
      testPrecision: modelRows.map((m) => m.test_precision ?? null),
      testRecall: modelRows.map((m) => m.test_recall ?? null),
    };
  }, [modelRows]);

  useEffect(() => {
    if (!chartDataset.labels.length || activePage !== 'overview') return;

    const aucCtx = document.getElementById('aucChart');
    const prfCtx = document.getElementById('prfChart');
    if (!aucCtx || !prfCtx) return;

    const auc = new Chart(aucCtx, {
      type: 'bar',
      data: {
        labels: chartDataset.labels,
        datasets: [
          { label: 'Eğitim ROC-AUC', data: chartDataset.trainAuc },
          { label: 'Test ROC-AUC', data: chartDataset.testAuc },
        ],
      },
      options: { responsive: true, scales: { y: { min: 0.5, max: 1 } } },
    });

    const prf = new Chart(prfCtx, {
      type: 'line',
      data: {
        labels: chartDataset.labels,
        datasets: [
          { label: 'Precision', data: chartDataset.testPrecision },
          { label: 'Recall', data: chartDataset.testRecall },
          { label: 'F1', data: chartDataset.testF1 },
        ],
      },
      options: { responsive: true, scales: { y: { min: 0, max: 1 } } },
    });

    return () => {
      auc.destroy();
      prf.destroy();
    };
  }, [chartDataset, activePage]);

  if (!authenticated) {
    return (
      <div className="loginPage">
        <form className="loginCard" onSubmit={handleLogin}>
          <h1>Kurumsal Dashboard Girişi</h1>
          <p>Yetkili kullanıcı hesabınızla giriş yapın.</p>

          <label>Kullanıcı Adı</label>
          <input value={username} onChange={(e) => setUsername(e.target.value)} required />

          <label>Şifre</label>
          <input
            type="password"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            required
          />

          {loginError ? <div className="error smallError">{loginError}</div> : null}

          <button type="submit">Giriş Yap</button>
        </form>
      </div>
    );
  }

  const navItems = [
    { key: 'overview', label: 'Genel Bakış' },
    { key: 'models', label: 'Model Analizi' },
    { key: 'runs', label: 'Run Geçmişi' },
    { key: 'system', label: 'Sistem ve Veritabanı' },
  ];

  return (
    <div className="appShell">
      <aside className="sidebar">
        <div className="sidebarTitle">Kurumsal Panel</div>
        <div className="sidebarSub">Rezervasyon Tahmin</div>
        <nav className="sidebarNav">
          {navItems.map((item) => (
            <button
              key={item.key}
              className={`navBtn ${activePage === item.key ? 'active' : ''}`}
              onClick={() => setActivePage(item.key)}
            >
              {item.label}
            </button>
          ))}
        </nav>

        <button className="logoutBtn" onClick={handleLogout}>Çıkış Yap</button>
      </aside>

      <main className="container">
        <div className="topBar">
          <div className="brandBlock">
            <div className="brandTitle">DS Project Kurumsal Dashboard</div>
            <div className="brandSub">Model İzleme ve Karar Destek Paneli</div>
          </div>
          <div className="metaBlock">
            <span className="metaItem"><strong>Kullanıcı:</strong> {currentUser || '-'}</span>
            <span className="metaItem"><strong>Run:</strong> {selectedRun || '-'}</span>
            <span className="metaItem"><strong>Güncelleme:</strong> {generatedAt}</span>
          </div>
        </div>

        <header className="pageHeader">
          <h1>Rezervasyon İptal Tahmin Yönetimi</h1>
          <p className="subtitle">
            Üstte özet KPI'ları, altta model karşılaştırmaları ve operasyonel karar metrikleri yer alır.
          </p>
        </header>

        <section className="card controls">
          <div className="controlTitle">Filtreler</div>
          <div>
            <label>Model Koşusu (Run ID)</label>
            <select
              value={selectedRun}
              onChange={(e) => {
                const next = e.target.value;
                setSelectedRun(next);
                refreshOverviewOnly(next);
              }}
            >
              {runs.map((r) => (
                <option key={r} value={r}>
                  {r}
                </option>
              ))}
            </select>
          </div>

          <div>
            <label>API Anahtarı (opsiyonel)</label>
            <input
              value={apiKey}
              onChange={(e) => setApiKey(e.target.value)}
              placeholder="x-api-key"
            />
          </div>

          <button onClick={refreshRunsAndData}>Verileri Yenile</button>
        </section>

        {error ? <div className="error card">Hata: {error}</div> : null}

        {activePage === 'overview' ? (
          <>
            <section className="statusBar card">
              <div className="statusItem">
                <span className="statusLabel">Sistem Durumu</span>
                <span className="statusBadge ok">Aktif</span>
              </div>
              <div className="statusItem">
                <span className="statusLabel">Model Politikası</span>
                <span className="statusBadge neutral">{champion.ranking_mode || 'Standart'}</span>
              </div>
              <div className="statusItem">
                <span className="statusLabel">Kayıtlı Model Sayısı</span>
                <span className="statusBadge neutral">{modelRows.length}</span>
              </div>
            </section>

            <section className="grid4">
              <div className="card">
                <div className="k">Kullanılan Model</div>
                <div className="v">{champion.selected_model || '-'}</div>
                <div className="helpText">Sistem şu an bu modelle karar veriyor.</div>
              </div>
              <div className="card">
                <div className="k">Karar Eşiği</div>
                <div className="v">{f(champion.threshold, 3)}</div>
                <div className="helpText">Bu değerin üstü “aksiyon al” olarak işaretlenir.</div>
              </div>
              <div className="card">
                <div className="k">Beklenen Net Kazanç</div>
                <div className="v">{champion.expected_net_profit ? Number(champion.expected_net_profit).toLocaleString('tr-TR') : '-'}</div>
                <div className="helpText">Modelin bu kurguya göre getirmesi beklenen toplam fayda.</div>
              </div>
              <div className="card">
                <div className="k">Maksimum Aksiyon Oranı</div>
                <div className="v">{pct(champion.max_action_rate)}</div>
                <div className="helpText">Toplam müşterinin en fazla bu oranına müdahale edilir.</div>
              </div>
            </section>

            <section className="grid2">
              <div className="card">
                <div className="small">Model Başarısı: Eğitim ve Test Karşılaştırması</div>
                <div className="explain">Skor 1 değerine yaklaştıkça performans artar. Eğitim ve test değerlerinin yakın olması kurumsal stabilite için önemlidir.</div>
                <canvas id="aucChart" height="180" />
              </div>
              <div className="card">
                <div className="small">Test Sonuçları: Precision / Recall / F1</div>
                <div className="explain">Precision yanlış alarmı azaltır, Recall kritik vakaları kaçırmamayı sağlar, F1 ise iki metriğin dengeli özetidir.</div>
                <canvas id="prfChart" height="180" />
              </div>
            </section>
          </>
        ) : null}

        {activePage === 'models' ? (
          <section className="card">
            <div className="small">Detaylı Model Analizi</div>
            <div className="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Model</th>
                    <th>Eğitim Skoru</th>
                    <th>Test Skoru</th>
                    <th>F1</th>
                    <th>Precision</th>
                    <th>Recall</th>
                    <th>Eşik</th>
                    <th>Test Kayıt</th>
                  </tr>
                </thead>
                <tbody>
                  {modelRows.map((m) => (
                    <tr key={m.model_name}>
                      <td>{m.model_name}</td>
                      <td>{f(m.train_cv_roc_auc_mean)} ± {f(m.train_cv_roc_auc_std)}</td>
                      <td>{f(m.test_roc_auc)}</td>
                      <td>{f(m.test_f1)}</td>
                      <td>{f(m.test_precision)}</td>
                      <td>{f(m.test_recall)}</td>
                      <td>{f(m.test_threshold, 3)}</td>
                      <td>{m.n_test ?? '-'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </section>
        ) : null}

        {activePage === 'runs' ? (
          <section className="card">
            <div className="small">Run Geçmişi</div>
            <div className="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Run ID</th>
                  </tr>
                </thead>
                <tbody>
                  {runs.map((r) => (
                    <tr key={r}>
                      <td>{r}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </section>
        ) : null}

        {activePage === 'system' ? (
          <section className="card">
            <div className="small">Sistem ve Veritabanı Durumu</div>
            <div className="systemGrid">
              <div className="sysItem"><span>DB Motoru</span><strong>{dbStatus?.database_backend || '-'}</strong></div>
              <div className="sysItem"><span>Bağlantı</span><strong>{dbStatus?.connected ? 'Bağlı' : 'Bağlı Değil'}</strong></div>
              <div className="sysItem full"><span>DB URL</span><strong>{dbStatus?.database_url || '-'}</strong></div>
              <div className="sysItem full"><span>Not</span><strong>{dbStatus?.reason || '-'}</strong></div>
            </div>
            <button onClick={refreshDbStatus}>DB Durumunu Yenile</button>
          </section>
        ) : null}

        <section className="card">
          <div className="legendBox">
            <strong>Kısa Sözlük:</strong>
            <ul>
              <li><strong>Precision</strong>: “İptal olur” dediklerimizin ne kadarı gerçekten iptal oldu?</li>
              <li><strong>Recall</strong>: Gerçekten iptal olanların ne kadarını yakaladık?</li>
              <li><strong>F1</strong>: Precision ve Recall dengesinin tek sayıdaki özeti.</li>
            </ul>
          </div>
        </section>
      </main>
    </div>
  );
}
