apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: ds-project-api-rules
  namespace: ds-project
spec:
  groups:
    - name: ds-project-api
      rules:
        - alert: DSProjectHighP95Latency
          expr: histogram_quantile(0.95, sum(rate(ds_api_request_latency_seconds_bucket[5m])) by (le)) > 0.3
          for: 15m
          labels:
            severity: warning
            service: ds-project-api
          annotations:
            summary: "DS API p95 latency breach"
            description: "p95 latency above 300ms for 15m"

        - alert: DSProjectHigh5xxRate
          expr: sum(rate(ds_api_requests_total{status=~"5.."}[5m])) / clamp_min(sum(rate(ds_api_requests_total[5m])), 0.001) > 0.001
          for: 10m
          labels:
            severity: critical
            service: ds-project-api
          annotations:
            summary: "DS API 5xx rate breach"
            description: "5xx ratio above 0.1% for 10m"

        - alert: DSProjectErrorBudgetBurnFast
          expr: sum(rate(ds_api_requests_total{status=~"5.."}[5m])) / clamp_min(sum(rate(ds_api_requests_total[5m])), 0.001) > (14.4 * 0.001)
          for: 5m
          labels:
            severity: critical
            service: ds-project-api
          annotations:
            summary: "Fast error-budget burn detected"
            description: "5xx ratio is burning monthly error budget >14.4x. Trigger rollback/canary halt."

        - alert: DSProjectErrorBudgetBurnSlow
          expr: sum(rate(ds_api_requests_total{status=~"5.."}[30m])) / clamp_min(sum(rate(ds_api_requests_total[30m])), 0.001) > (6 * 0.001)
          for: 30m
          labels:
            severity: warning
            service: ds-project-api
          annotations:
            summary: "Slow error-budget burn detected"
            description: "5xx ratio is burning monthly error budget >6x. Freeze releases and investigate."

        - alert: DSProjectInferenceErrorsSpike
          expr: sum(rate(ds_api_inference_errors_total[5m])) > 0.2
          for: 10m
          labels:
            severity: warning
            service: ds-project-api
          annotations:
            summary: "Inference errors are elevated"
            description: "Inference error rate above threshold"

        - alert: DSProjectHighPSI
          expr: ds_feature_psi > 0.2
          for: 5m
          labels:
            severity: warning
            service: ds-project-api
          annotations:
            summary: "Feature PSI drift detected: {{ $labels.feature }}"
            description: "PSI {{ $value | humanize }} > 0.2 for feature {{ $labels.feature }} — distribution shift likely"

        - alert: DSProjectLowAUC
          expr: ds_model_roc_auc < 0.65
          for: 10m
          labels:
            severity: critical
            service: ds-project-api
          annotations:
            summary: "Model AUC degraded below SLO"
            description: "ROC-AUC {{ $value | humanize }} < 0.65 for model {{ $labels.model }} — consider retraining"

        - alert: DSProjectActionRateAnomaly
          expr: |
            abs(ds_model_action_rate - avg_over_time(ds_model_action_rate[7d])) > 0.15
          for: 15m
          labels:
            severity: warning
            service: ds-project-api
          annotations:
            summary: "Action rate anomaly detected"
            description: "Action rate {{ $value | humanize }} deviates >15pp from 7-day average — check model or data"
