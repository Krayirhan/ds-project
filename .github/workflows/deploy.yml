name: deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      skip_staging:
        description: "Skip staging and deploy directly to prod (emergency only)"
        required: false
        default: "false"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  HELM_CHART_PATH: deploy/helm/ds-project

jobs:
  # â”€â”€ 1. Build & Push Docker Image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_tag: ${{ steps.meta.outputs.version }}
      image_digest: ${{ steps.build.outputs.digest }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.repository_owner }}
          password: ${{ github.token }}

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/krayirhan/ds-project
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}
          github-token: ${{ github.token }}

      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}

  # â”€â”€ 2. Deploy to Staging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-staging:
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.skip_staging != 'true'
    environment: staging
    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Configure kubectl
        uses: azure/k8s-set-context@v4
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}

      - name: Deploy to staging namespace
        run: |
          helm upgrade --install ds-project-staging ${{ env.HELM_CHART_PATH }} \
            --namespace ds-project-staging \
            --create-namespace \
            --values ${{ env.HELM_CHART_PATH }}/values.yaml \
            --values ${{ env.HELM_CHART_PATH }}/values-staging.yaml \
            --set image.tag=${{ needs.build.outputs.image_tag }} \
            --wait \
            --timeout 5m

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/ds-project-staging \
            --namespace ds-project-staging \
            --timeout=180s

  # â”€â”€ 3. Smoke Tests on Staging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  smoke-staging:
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: ${{ needs['deploy-staging'].result == 'success' }}
    steps:
      - uses: actions/checkout@v4

      - name: Configure kubectl
        uses: azure/k8s-set-context@v4
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG_STAGING }}

      - name: Port-forward staging API
        run: |
          kubectl port-forward svc/ds-project-staging 8000:80 \
            --namespace ds-project-staging &
          sleep 5

      - name: Health check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/health)
          if [ "$response" != "200" ]; then
            echo "âŒ Health check failed with status $response"
            exit 1
          fi
          echo "âœ… Health check passed"

      - name: Readiness check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/ready)
          if [ "$response" != "200" ]; then
            echo "âŒ Readiness check failed with status $response"
            exit 1
          fi
          echo "âœ… Readiness check passed"

      - name: Metrics endpoint check
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8000/metrics)
          if [ "$response" != "200" ]; then
            echo "âŒ Metrics check failed with status $response"
            exit 1
          fi
          echo "âœ… Metrics endpoint passed"

      - name: API v1 decide smoke test
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" \
            -X POST http://localhost:8000/v1/decide \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.STAGING_API_KEY }}" \
            -d '{"records": []}')
          echo "Decide endpoint returned: $response"

  # â”€â”€ 4. Approve for Production â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  approve-production:
    runs-on: ubuntu-latest
    needs: [build, smoke-staging]
    if: |
      always() &&
      needs.build.result == 'success' &&
      (needs['smoke-staging'].result == 'success' || needs['smoke-staging'].result == 'skipped')
    steps:
      - name: Approval gate
        run: echo "âœ… Production deployment approved"

  # â”€â”€ 5. Deploy to Production â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-production:
    runs-on: ubuntu-latest
    needs: [build, approve-production]
    if: |
      always() &&
      needs.build.result == 'success' &&
      needs['approve-production'].result == 'success'
    steps:
      - uses: actions/checkout@v4

      - name: Install Helm
        uses: azure/setup-helm@v3
        with:
          version: v3.14.0

      - name: Configure kubectl
        uses: azure/k8s-set-context@v4
        with:
          kubeconfig: ${{ secrets.KUBE_CONFIG_PRODUCTION }}

      - name: Deploy to production
        run: |
          helm upgrade --install ds-project ${{ env.HELM_CHART_PATH }} \
            --namespace ds-project \
            --create-namespace \
            --values ${{ env.HELM_CHART_PATH }}/values.yaml \
            --values ${{ env.HELM_CHART_PATH }}/values-production.yaml \
            --set image.tag=${{ needs.build.outputs.image_tag }} \
            --wait \
            --timeout 10m

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/ds-project \
            --namespace ds-project \
            --timeout=300s

      - name: Post-deploy health check
        run: |
          sleep 10
          kubectl exec -n ds-project \
            $(kubectl get pod -n ds-project -l app.kubernetes.io/name=ds-project -o jsonpath='{.items[0].metadata.name}') \
            -- python -c "import urllib.request; print(urllib.request.urlopen('http://127.0.0.1:8000/health', timeout=5).read())"

      - name: Notify deployment success
        if: success()
        run: |
          echo "ğŸš€ Production deployment completed: image=${{ needs.build.outputs.image_tag }}"

      - name: Notify deployment failure
        if: failure()
        run: |
          echo "ğŸ”´ Production deployment FAILED: image=${{ needs.build.outputs.image_tag }}"
