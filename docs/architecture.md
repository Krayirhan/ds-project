# Architecture Overview

## System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CI / CD  Pipeline                             │
│  ┌──────────┐   ┌──────────┐   ┌───────────┐   ┌────────┐   ┌──────────┐ │
│  │  Lint     │──▶│  Test    │──▶│  Build    │──▶│ Deploy │──▶│  Smoke   │ │
│  │  ruff     │   │  pytest  │   │  Docker   │   │ Staging│   │  Tests   │ │
│  │  mypy     │   │  bandit  │   │  GHCR     │   │  Helm  │   │  HTTP    │ │
│  └──────────┘   └──────────┘   └───────────┘   └────┬───┘   └────┬─────┘ │
│                                                      │    Approve │       │
│                                                      ▼            ▼       │
│                                                 ┌──────────────────┐      │
│                                                 │  Deploy Prod     │      │
│                                                 │  (Helm + ArgoCD) │      │
│                                                 └──────────────────┘      │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              Kubernetes Cluster                            │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────┐        │
│  │                    ds-project namespace                         │        │
│  │                                                                 │        │
│  │  ┌─────────────┐     ┌─────────────┐     ┌──────────────┐     │        │
│  │  │  Ingress     │────▶│  Service    │────▶│  Deployment  │     │        │
│  │  │  (nginx)     │     │  (ClusterIP)│     │  (2-10 pods) │     │        │
│  │  └──────┬──────┘     └─────────────┘     └──────┬───────┘     │        │
│  │         │                                        │              │        │
│  │         │  canary 10%                            │              │        │
│  │         ▼                                        ▼              │        │
│  │  ┌─────────────┐                         ┌──────────────┐     │        │
│  │  │  Canary     │                          │  HPA         │     │        │
│  │  │  Service    │                          │  (CPU 70%)   │     │        │
│  │  └─────────────┘                          └──────────────┘     │        │
│  │                                                                 │        │
│  │  ┌────────────┐  ┌───────────┐  ┌────────────┐                │        │
│  │  │ NetworkPol │  │  PDB      │  │ Secrets    │                │        │
│  │  └────────────┘  └───────────┘  └────────────┘                │        │
│  └─────────────────────────────────────────────────────────────────┘        │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                           Application Architecture                         │
│                                                                             │
│  ┌──────────────────────────────────────────────────┐                      │
│  │                  FastAPI Application              │                      │
│  │                                                    │                      │
│  │  ┌─────────────────────────────────────────────┐  │                      │
│  │  │              Middleware Stack                │  │                      │
│  │  │  Request ID → Auth → Rate Limit → Payload   │  │                      │
│  │  └─────────────────────┬───────────────────────┘  │                      │
│  │                        │                           │                      │
│  │  ┌─────────┬──────────┬──────────┐               │                      │
│  │  │  Root   │  /v1/*   │  /v2/*   │  ◀─ Versioned│                      │
│  │  │ (compat)│ (stable) │ (+meta)  │     Routers  │                      │
│  │  └────┬────┴────┬─────┴────┬─────┘               │                      │
│  │       │         │          │                       │                      │
│  │       ▼         ▼          ▼                       │                      │
│  │  ┌──────────────────────────────────────────┐     │                      │
│  │  │           Serving State                   │     │                      │
│  │  │  ┌──────────┐ ┌────────┐ ┌────────────┐ │     │                      │
│  │  │  │  Model   │ │ Policy │ │FeatureSpec │ │     │                      │
│  │  │  │ (.joblib)│ │ (.json)│ │  (.json)   │ │     │                      │
│  │  │  └──────────┘ └────────┘ └────────────┘ │     │                      │
│  │  └──────────────────────────────────────────┘     │                      │
│  └──────────────────────────────────────────────────┘                      │
│                                                                             │
│  ┌─────────────────────────────────────────────────────┐                   │
│  │                Observability Stack                   │                   │
│  │                                                       │                   │
│  │  ┌────────────┐  ┌───────────┐  ┌────────────────┐  │                   │
│  │  │ Prometheus │  │  Grafana  │  │  Jaeger/Tempo  │  │                   │
│  │  │  /metrics  │  │ Dashboards│  │  OTLP Traces   │  │                   │
│  │  └────────────┘  └───────────┘  └────────────────┘  │                   │
│  │                                                       │                   │
│  │  ┌──────────────┐  ┌────────────────┐                │                   │
│  │  │ Alertmanager │  │  Pandera       │                │                   │
│  │  │ Slack/PD     │  │  Data Valid.   │                │                   │
│  │  └──────────────┘  └────────────────┘                │                   │
│  └─────────────────────────────────────────────────────┘                   │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                             ML Pipeline (DVC)                              │
│                                                                             │
│  ┌──────┐   ┌────────────┐   ┌───────┐   ┌───────┐   ┌──────────┐        │
│  │ Raw  │──▶│ Preprocess │──▶│ Split │──▶│ Train │──▶│ Evaluate │        │
│  │ CSV  │   │ + Validate │   │       │   │       │   │          │        │
│  └──────┘   └────────────┘   └───────┘   └───┬───┘   └────┬─────┘        │
│                  ▲                            │            │               │
│                  │                            ▼            ▼               │
│             ┌─────────┐              ┌────────────┐ ┌──────────┐          │
│             │ Pandera │              │ Calibrate  │ │  Policy  │          │
│             │ Schema  │              │ iso + sig  │ │  Select  │          │
│             └─────────┘              └────────────┘ └──────────┘          │
│                                                                             │
│  Models: Baseline (LR) + XGBoost + LightGBM + CatBoost + HistGB           │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Data Flow

```
Hotel Booking Data (CSV)
        │
        ▼
  ┌──────────────┐
  │ Pandera Raw  │──── Schema violation? → FAIL FAST
  │ Validation   │
  └──────┬───────┘
         │
         ▼
  ┌──────────────┐
  │  Preprocess  │──── Leakage removal, label normalization
  └──────┬───────┘
         │
         ▼
  ┌──────────────┐
  │ Pandera Proc │──── Post-processing contract check
  │ Validation   │
  └──────┬───────┘
         │
    ┌────┴─────┐
    ▼          ▼
  Train      Test
    │          │
    ▼          ▼
  Models   Evaluate
    │      (cost-optimal)
    ▼          │
  Calibrate    ▼
    │      Decision Policy
    ▼          │
  Artifacts    ▼
  (.joblib) + (.json)
         │
         ▼
  ┌──────────────┐
  │  API Serve   │──── /v1/decide, /v2/decide
  │  (FastAPI)   │
  └──────┬───────┘
         │
    ┌────┴────┐
    ▼         ▼
  Metrics   Traces
  (Prom)    (OTel)
```
